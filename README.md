# MC-DEPI Analysis Notebooks

This repository contains analysis notebooks for the paper:

> *Monte-Carlo Diffusion-Enhanced Photon Inference:*
> *Distance Distributions and Conformational Dynamics in single-molecule FRET*
>
> Antonino Ingargiola, Shimon Weiss, Eitan Lerner (2018) https://doi.org/10.1101/385252

These notebooks also serve as an example on using the [depi](https://github.com/opensmfs/depi) package.

# Workflow Overview

## Preprocessing: burst search and grouping
> *Notebooks:*
> 1. [Export TCSPC decays from ns-ALEX Photon-HDF5.ipynb](https://nbviewer.jupyter.org/github/tritemio/mcdepi2018-paper-analysis/blob/master/Export%20TCSPC%20decays%20from%20ns-ALEX%20Photon-HDF5.ipynb)
> 2. [PIE Analysis and save bursts.ipynb](https://nbviewer.jupyter.org/github/tritemio/mcdepi2018-paper-analysis/blob/master/PIE%20Analysis%20and%20save%20bursts.ipynb)
> 3. [Batch run notebook.ipynb
](https://nbviewer.jupyter.org/github/tritemio/mcdepi2018-paper-analysis/blob/master/Batch%20run%20notebook.ipynb)
> 4. [Group Results by Name.ipynb ](https://nbviewer.jupyter.org/github/tritemio/mcdepi2018-paper-analysis/blob/master/Group%20Results%20by%20Name.ipynb)

Each sample has several smFRET-PIE measurements in PicoQuant format. First the raw data files are converted to Photon-HDF5
using notebook [1]. Next, a notebook[2] for burst-search and population selection (D-only, FRET)
is executed in batch (using [3]) on all the data files for a given sample. 
Bursts for each (sample, population) pair are grouped in a single data file[4] for further analysis.

## Experimental data analysis and simulation fitting
> *Notebooks:*
>
> 5. [Burst Analysis-DEPI-exp.ipynb](https://nbviewer.jupyter.org/github/tritemio/mcdepi2018-paper-analysis/blob/master/Burst%20Analysis-DEPI-exp.ipynb)
> 6. [Burst Analysis-DEPI-sim2-E_nanotime.ipynb](https://nbviewer.jupyter.org/github/tritemio/mcdepi2018-paper-analysis/blob/master/Burst%20Analysis-DEPI-sim2-E_nanotime.ipynb) (7d sample)
> 7. [Burst Analysis-DEPI-sim2-E_nanotime-17d-bg-irf.ipynb](https://nbviewer.jupyter.org/github/tritemio/mcdepi2018-paper-analysis/blob/master/Burst%20Analysis-DEPI-sim2-E_nanotime-17d-bg-irf.ipynb) (17d sample)

We perform the experimental and simulated data analysis for each sample in similar fashion. 
For the experimental analysis[5] we use bursts aggregated from from multiple measurements in the previous step.
The simulated data is generated by an MC-DEPI simulation with user-defined distance distribution and self-diffusion
parameters[6, 7]. Simulations have the same number of photons as the experimental burst photon-data, with "recoloring"
(i.e. reassigned D and A labels) and with with simulated TCSPC nanotimes. The simulation takes into
account multiple comformational states with arbitrary transition matrix, a distance distribution model for each state,
a D-A diffusion relaxation time for each state, acceptor photo-blinking, correction factors (gamma, donor leakage,
acceptor direct excitation from donor laser), background counts.
In the paper we compare FRET histograms and D and A fluorescence decays between experiments and simulations. 
Other analysis carried out in the notebooks are FCS, BVA.

The notebooks [8] and [9] repeat the simulations 100 times using the same input parameters, but different seeds 
for the random number generation. In this way, we assess the dispersion of the simulation due to the sole 
Monte Carlo noise. The dispersion is assessed both graphically and computing the standard deviation of the 
loss function.

The notebooks, [6] and [7], first perform a single user-define simulation, then they compute the loss function
and finally the run an optimization procedure to find the best parameters fitting the experimental data.
The standard deviation of the loss function is important for the convergence of the optimizatio algorithm.

# Dependencies

- python >= 3.6
- [depi](https://github.com/opensmfs/depi) >= 0.1+14.g413c350
- [scikit-optimze](https://scikit-optimize.github.io/) >= 0.5.2+39.g000b9d8
- [randomgen](https://bashtage.github.io/randomgen/) ==1.14.4 (next-generation RNG, soon to be included in numpy)
